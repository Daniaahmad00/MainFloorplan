<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Private Suite Occupancy Floorplan Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4 font-sans">

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left Panel -->
  <div class="col-span-1 bg-white p-6 rounded-xl shadow">
    <h1 class="text-3xl font-bold text-orange-600 mb-2">
      PS Occupancy <span class="text-xl font-medium text-gray-600">(Floorplan)</span>
    </h1>

    <!-- Filters -->
    <div class="space-y-4 mt-6">
      <div>
        <label class="block font-semibold mb-1">Outlet</label>
        <select id="filter-outlet" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Status</label>
        <select id="filter-status" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Pax Size</label>
        <select id="filter-pax" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Suite</label>
        <select id="filter-suite" class="w-full p-2 border rounded"></select>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="col-span-2 bg-white p-6 rounded-xl shadow relative">
    <div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50 hidden" id="loading-spinner">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-orange-600 border-solid"></div>
    </div>
    <iframe id="floor-img" src="8FA/index.html" frameborder="0" class="w-full h-[89vh]"></iframe>
  </div>
</div>

<script>
const outletMap = { '67ad665a9aa9ef620e693aa0': '8FA' };
let roomData = [];

// Show spinner
function showSpinner() {
  document.getElementById("loading-spinner").classList.remove("hidden");
}
// Hide spinner
function hideSpinner() {
  document.getElementById("loading-spinner").classList.add("hidden");
}

// Fetch room data
async function fetchData() {
  showSpinner();
  const res = await fetch('https://script.google.com/macros/s/AKfycbxKhih7njEt3fiRMvbJnHOTYUCeHlENVMK7i5EosmE65lZE_K7esXdNJ7tAjIHRNwEg/exec');
  const data = await res.json();
  roomData = data.map(item => ({
    id: item.id,
    name: item.name,
    status: item.status.toLowerCase(),
    outlet: outletMap[item.outlet_id],
    capacity: item.capacity
  }));
  populateFilters();
  sendFiltersToChild();
}

// Populate dropdowns
function populateFilters() {
  const outletSet = new Set(), statusSet = new Set(), paxSet = new Set(), suiteSet = new Set();
  roomData.forEach(r => {
    outletSet.add(r.outlet);
    statusSet.add(r.status);
    paxSet.add(r.capacity);
    suiteSet.add(r.name);
  });
  const filterMap = {
    'filter-outlet': outletSet,
    'filter-status': statusSet,
    'filter-pax': paxSet,
    'filter-suite': suiteSet
  };
  for (const [id, set] of Object.entries(filterMap)) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="all">All</option>' +
      [...set].sort().map(v => `<option value="${v}">${v}</option>`).join('');
    select.addEventListener('change', sendFiltersToChild);
  }
}

// Send filters to child iframe
function sendFiltersToChild() {
  showSpinner();
  const frame = document.getElementById("floor-img");
  if (!frame || !frame.contentWindow) return;

  const selectedOutlet = document.getElementById("filter-outlet").value;
  const selectedStatus = (document.getElementById("filter-status").value || "all").toLowerCase();
  const selectedPax = document.getElementById("filter-pax").value;
  const selectedSuite = document.getElementById("filter-suite").value;

  const filteredRooms = roomData.filter(room => {
    return (selectedOutlet === "all" || room.outlet === selectedOutlet) &&
           (selectedPax === "all" || room.capacity == selectedPax) &&
           (selectedSuite === "all" || room.name === selectedSuite);
  });

  const roomIds = filteredRooms.map(r => r.id);
  const statusMap = {};
  filteredRooms.forEach(r => statusMap[r.id] = r.status);

  frame.contentWindow.postMessage(
    { roomIds, statusFilter: selectedStatus, statusMap },
    "*"
  );
}

// Listen for child ready or update
window.addEventListener("message", (event) => {
  if (event.data === "ready" || event.data === "applied") {
    hideSpinner();
  }
});

fetchData();
</script>
</body>
</html>
